

--------------------------------------------------------------------
-- VCB TIMER PATCH (PASTE THIS AT THE VERY END OF YOUR SCRIPT)
-- Adds VCB button left of Refresh + timer pill + dropdown menu
--------------------------------------------------------------------
do
	local TeleportService = game:GetService("TeleportService")

	local VCB_DEFAULT_5 = 5 * 60
	local VCB_DEFAULT_6 = 6 * 60

	local vcbTopBar
	local vcbBtn
	local vcbPill
	local vcbPillLabel

	local vcbMenu
	local vcbBigTime
	local vcbStatus
	local vcbStart5
	local vcbStart6
	local vcbStop
	local vcbPause
	local vcbResume
	local vcbClose

	local vcbOpen = false

	local vcbState = {
		running = false,
		paused = false,
		duration = 0,
		remaining = 0,
		endAt = 0,
		lastDuration = VCB_DEFAULT_5,
		rejoinArmed = false,
		rejoined = false,
	}

	local function clamp(n, a, b)
		if n < a then return a end
		if n > b then return b end
		return n
	end

	local function formatTime(secs)
		secs = math.max(0, math.floor(secs + 0.5))
		local m = math.floor(secs / 60)
		local s = secs % 60
		return string.format("%02d:%02d", m, s)
	end

	local function setButtonTextRich(btn, txt)
		if not btn then return end
		btn.RichText = true
		btn.Text = txt
	end

	local function setLabelTextRich(lbl, txt)
		if not lbl then return end
		lbl.RichText = true
		lbl.Text = txt
	end

	local function updateTopText()
		local t = vcbState.running and formatTime(vcbState.remaining) or "00:00"
		local red = "#ff3c3c"

		if vcbPillLabel then
			setLabelTextRich(vcbPillLabel, 'Time left: <font color="' .. red .. '">' .. t .. "</font>")
		end

		if vcbBtn then
			if (not vcbOpen) and vcbState.running then
				setButtonTextRich(vcbBtn, 'VCB <font color="' .. red .. '">' .. t .. "</font>")
			else
				setButtonTextRich(vcbBtn, "VCB")
			end
		end

		if vcbBigTime then
			setLabelTextRich(vcbBigTime, '<font color="' .. red .. '">' .. t .. "</font>")
		end
	end

	local function updateStatusText()
		if not vcbStatus then return end

		if not vcbState.running then
			vcbStatus.Text = "Idle. Press Start when you get VCB."
			return
		end

		if vcbState.paused then
			vcbStatus.Text = "Paused. Timer will not rejoin you."
			return
		end

		vcbStatus.Text = "Running. Will rejoin at 00:00 unless paused."
	end

	local function updateAllText()
		updateTopText()
		updateStatusText()
	end

	local function armRejoin()
		vcbState.rejoinArmed = true
		vcbState.rejoined = false
	end

	local function disarmRejoin()
		vcbState.rejoinArmed = false
	end

	local function stopTimer()
		vcbState.running = false
		vcbState.paused = false
		vcbState.duration = 0
		vcbState.remaining = 0
		vcbState.endAt = 0
		disarmRejoin()
		updateAllText()
	end

	local function pauseTimer()
		if not vcbState.running then return end
		if vcbState.paused then return end

		vcbState.paused = true
		vcbState.remaining = math.max(0, vcbState.endAt - os.clock())
		disarmRejoin()
		updateAllText()
	end

	local function resumeTimer()
		if not vcbState.running then return end
		if not vcbState.paused then return end

		vcbState.paused = false
		vcbState.endAt = os.clock() + vcbState.remaining
		armRejoin()
		updateAllText()
	end

	local function startTimer(seconds)
		seconds = tonumber(seconds) or VCB_DEFAULT_5
		seconds = math.max(1, math.floor(seconds))

		vcbState.running = true
		vcbState.paused = false
		vcbState.duration = seconds
		vcbState.remaining = seconds
		vcbState.endAt = os.clock() + seconds
		vcbState.lastDuration = seconds
		armRejoin()

		updateAllText()
	end

	local function rejoinSameServer()
		if vcbState.rejoined then return end
		vcbState.rejoined = true

		local placeId = game.PlaceId
		local jobId = game.JobId

		local ok = pcall(function()
			TeleportService:TeleportToPlaceInstance(placeId, jobId, LocalPlayer)
		end)

		if not ok then
			pcall(function()
				TeleportService:Teleport(placeId, LocalPlayer)
			end)
		end
	end

	local function setMenuOpen(open)
		vcbOpen = open and true or false
		if vcbMenu then
			vcbMenu.Visible = vcbOpen
		end
		updateTopText()
	end

	local function styleTopPill(obj)
		obj.BackgroundColor3 = Color3.fromRGB(16, 16, 20)
		obj.BackgroundTransparency = 0.18
		obj.BorderSizePixel = 0
		makeCorner(obj, 12)
		makeStroke(obj, 2, Color3.fromRGB(200, 40, 40), 0.15)

		local g = Instance.new("UIGradient")
		g.Rotation = 90
		g.Color = ColorSequence.new({
			ColorSequenceKeypoint.new(0, Color3.fromRGB(30, 30, 38)),
			ColorSequenceKeypoint.new(1, Color3.fromRGB(10, 10, 12)),
		})
		g.Transparency = NumberSequence.new({
			NumberSequenceKeypoint.new(0, 0.10),
			NumberSequenceKeypoint.new(1, 0.22),
		})
		g.Parent = obj
	end

	local function styleMenuFrame(frame)
		makeCorner(frame, 16)
		makeGlass(frame)
		makeStroke(frame, 2, Color3.fromRGB(200, 40, 40), 0.10)
	end

	local function ensureVcbUi()
		ensureGui()

		while not refreshBtn or not refreshBtn.Parent do
			task.wait(0.05)
		end

		if vcbTopBar and vcbTopBar.Parent then
			return
		end

		vcbTopBar = Instance.new("Frame")
		vcbTopBar.Name = "VCB_TopBar"
		vcbTopBar.AnchorPoint = Vector2.new(1, 0)
		vcbTopBar.Position = UDim2.new(1, -18, 0, 20)
		vcbTopBar.Size = UDim2.new(0, 420, 0, 36)
		vcbTopBar.BackgroundTransparency = 1
		vcbTopBar.BorderSizePixel = 0
		vcbTopBar.ZIndex = 8000
		vcbTopBar.Parent = gui

		local list = Instance.new("UIListLayout")
		list.FillDirection = Enum.FillDirection.Horizontal
		list.SortOrder = Enum.SortOrder.LayoutOrder
		list.Padding = UDim.new(0, 10)
		list.VerticalAlignment = Enum.VerticalAlignment.Center
		list.Parent = vcbTopBar

		vcbBtn = Instance.new("TextButton")
		vcbBtn.Name = "VCB_Button"
		vcbBtn.LayoutOrder = 1
		vcbBtn.Size = UDim2.new(0, 86, 0, 36)
		vcbBtn.AutoButtonColor = true
		vcbBtn.Font = Enum.Font.GothamBold
		vcbBtn.TextSize = 14
		vcbBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
		vcbBtn.Text = "VCB"
		vcbBtn.ZIndex = 8001
		vcbBtn.Parent = vcbTopBar
		styleTopPill(vcbBtn)

		vcbPill = Instance.new("Frame")
		vcbPill.Name = "VCB_TimePill"
		vcbPill.LayoutOrder = 2
		vcbPill.Size = UDim2.new(0, 220, 0, 36)
		vcbPill.ZIndex = 8001
		vcbPill.Parent = vcbTopBar
		styleTopPill(vcbPill)

		local pillBtn = Instance.new("TextButton")
		pillBtn.Name = "Clicker"
		pillBtn.BackgroundTransparency = 1
		pillBtn.BorderSizePixel = 0
		pillBtn.Text = ""
		pillBtn.AutoButtonColor = false
		pillBtn.Size = UDim2.new(1, 0, 1, 0)
		pillBtn.ZIndex = 8002
		pillBtn.Parent = vcbPill

		vcbPillLabel = Instance.new("TextLabel")
		vcbPillLabel.Name = "Label"
		vcbPillLabel.BackgroundTransparency = 1
		vcbPillLabel.Size = UDim2.new(1, -16, 1, 0)
		vcbPillLabel.Position = UDim2.new(0, 8, 0, 0)
		vcbPillLabel.Font = Enum.Font.GothamBold
		vcbPillLabel.TextSize = 14
		vcbPillLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
		vcbPillLabel.TextXAlignment = Enum.TextXAlignment.Center
		vcbPillLabel.TextYAlignment = Enum.TextYAlignment.Center
		vcbPillLabel.ZIndex = 8003
		vcbPillLabel.Parent = vcbPill

		local pillConstraint = Instance.new("UITextSizeConstraint")
		pillConstraint.MinTextSize = 11
		pillConstraint.MaxTextSize = 14
		pillConstraint.Parent = vcbPillLabel
		vcbPillLabel.TextScaled = true

		refreshBtn.Parent = vcbTopBar
		refreshBtn.LayoutOrder = 3
		refreshBtn.AnchorPoint = Vector2.new(0, 0)
		refreshBtn.Position = UDim2.new(0, 0, 0, 0)
		refreshBtn.ZIndex = 8001
		refreshBtn.Size = UDim2.new(0, 140, 0, 36)

		vcbMenu = Instance.new("Frame")
		vcbMenu.Name = "VCB_Menu"
		vcbMenu.Size = UDim2.new(0, 520, 0, 170)
		vcbMenu.BackgroundTransparency = 0
		vcbMenu.BorderSizePixel = 0
		vcbMenu.Visible = false
		vcbMenu.ZIndex = 8050
		vcbMenu.Parent = gui
		styleMenuFrame(vcbMenu)

		local title = Instance.new("TextLabel")
		title.BackgroundTransparency = 1
		title.Position = UDim2.new(0, 16, 0, 10)
		title.Size = UDim2.new(1, -160, 0, 20)
		title.Font = Enum.Font.GothamBold
		title.TextSize = 16
		title.TextColor3 = Color3.fromRGB(255, 255, 255)
		title.TextXAlignment = Enum.TextXAlignment.Left
		title.Text = "VCB Timer"
		title.ZIndex = 8051
		title.Parent = vcbMenu

		vcbClose = makeButton(vcbMenu, "Close")
		vcbClose.AnchorPoint = Vector2.new(1, 0)
		vcbClose.Position = UDim2.new(1, -12, 0, 8)
		vcbClose.Size = UDim2.new(0, 110, 0, 32)
		vcbClose.ZIndex = 8052
		vcbClose.TextColor3 = Color3.fromRGB(255, 255, 255)

		vcbBigTime = Instance.new("TextLabel")
		vcbBigTime.BackgroundTransparency = 1
		vcbBigTime.Position = UDim2.new(0, 16, 0, 36)
		vcbBigTime.Size = UDim2.new(0, 200, 0, 44)
		vcbBigTime.Font = Enum.Font.GothamBlack
		vcbBigTime.TextSize = 36
		vcbBigTime.TextXAlignment = Enum.TextXAlignment.Left
		vcbBigTime.TextYAlignment = Enum.TextYAlignment.Center
		vcbBigTime.TextColor3 = Color3.fromRGB(255, 255, 255)
		vcbBigTime.ZIndex = 8051
		vcbBigTime.Parent = vcbMenu

		vcbStatus = Instance.new("TextLabel")
		vcbStatus.BackgroundTransparency = 1
		vcbStatus.Position = UDim2.new(0, 16, 0, 82)
		vcbStatus.Size = UDim2.new(1, -32, 0, 18)
		vcbStatus.Font = Enum.Font.Gotham
		vcbStatus.TextSize = 13
		vcbStatus.TextXAlignment = Enum.TextXAlignment.Left
		vcbStatus.TextYAlignment = Enum.TextYAlignment.Center
		vcbStatus.TextColor3 = Color3.fromRGB(200, 200, 200)
		vcbStatus.ZIndex = 8051
		vcbStatus.Parent = vcbMenu

		local btnPadLeft = 16
		local btnPadRight = 16
		local btnGap = 12

		local row1 = Instance.new("Frame")
		row1.BackgroundTransparency = 1
		row1.Position = UDim2.new(0, btnPadLeft, 0, 108)
		row1.Size = UDim2.new(1, -(btnPadLeft + btnPadRight), 0, 34)
		row1.ZIndex = 8051
		row1.Parent = vcbMenu

		local row1Layout = Instance.new("UIListLayout")
		row1Layout.FillDirection = Enum.FillDirection.Horizontal
		row1Layout.SortOrder = Enum.SortOrder.LayoutOrder
		row1Layout.Padding = UDim.new(0, btnGap)
		row1Layout.VerticalAlignment = Enum.VerticalAlignment.Center
		row1Layout.Parent = row1

		local row2 = Instance.new("Frame")
		row2.BackgroundTransparency = 1
		row2.Position = UDim2.new(0, btnPadLeft, 0, 146)
		row2.Size = UDim2.new(1, -(btnPadLeft + btnPadRight), 0, 34)
		row2.ZIndex = 8051
		row2.Parent = vcbMenu

		local row2Layout = Instance.new("UIListLayout")
		row2Layout.FillDirection = Enum.FillDirection.Horizontal
		row2Layout.SortOrder = Enum.SortOrder.LayoutOrder
		row2Layout.Padding = UDim.new(0, btnGap)
		row2Layout.VerticalAlignment = Enum.VerticalAlignment.Center
		row2Layout.Parent = row2

		local function sizeButtons()
			if not row1 or not row2 then return end
			local w1 = row1.AbsoluteSize.X
			local w2 = row2.AbsoluteSize.X
			local wRow1Btn = math.floor((w1 - (btnGap * 2)) / 3)
			local wRow2Btn = math.floor((w2 - btnGap) / 2)
			wRow1Btn = math.max(90, wRow1Btn)
			wRow2Btn = math.max(140, wRow2Btn)

			if vcbStart5 then vcbStart5.Size = UDim2.new(0, wRow1Btn, 0, 32) end
			if vcbStart6 then vcbStart6.Size = UDim2.new(0, wRow1Btn, 0, 32) end
			if vcbStop then vcbStop.Size = UDim2.new(0, wRow1Btn, 0, 32) end

			if vcbPause then vcbPause.Size = UDim2.new(0, wRow2Btn, 0, 32) end
			if vcbResume then vcbResume.Size = UDim2.new(0, wRow2Btn, 0, 32) end
		end

		vcbStart5 = makeButton(row1, "Start 5:00")
		vcbStart5.LayoutOrder = 1
		vcbStart5.ZIndex = 8052

		vcbStart6 = makeButton(row1, "Start 6:00")
		vcbStart6.LayoutOrder = 2
		vcbStart6.ZIndex = 8052

		vcbStop = makeButton(row1, "Stop")
		vcbStop.LayoutOrder = 3
		vcbStop.ZIndex = 8052

		vcbPause = makeButton(row2, "Pause")
		vcbPause.LayoutOrder = 1
		vcbPause.ZIndex = 8052

		vcbResume = makeButton(row2, "Resume")
		vcbResume.LayoutOrder = 2
		vcbResume.ZIndex = 8052

		row1:GetPropertyChangedSignal("AbsoluteSize"):Connect(sizeButtons)
		row2:GetPropertyChangedSignal("AbsoluteSize"):Connect(sizeButtons)
		task.defer(sizeButtons)

		local function updateLayout()
			if not vcbTopBar or not vcbTopBar.Parent then return end
			local cam = workspace.CurrentCamera
			if not cam then return end

			local vp = cam.ViewportSize
			local margin = 18
			local gap = 10

			local vcbW = vcbBtn and vcbBtn.AbsoluteSize.X or 86
			local refreshW = refreshBtn and refreshBtn.AbsoluteSize.X or 140

			local maxTotal = math.max(260, vp.X - (margin * 2))
			local minPill = 170
			local maxPill = 300

			local pillW = clamp(maxTotal - (vcbW + refreshW + gap + gap), minPill, maxPill)

			vcbPill.Size = UDim2.new(0, pillW, 0, 36)
			vcbTopBar.Size = UDim2.new(0, vcbW + pillW + refreshW + (gap * 2), 0, 36)

			if vcbMenu then
				local menuW = vcbMenu.AbsoluteSize.X
				local menuH = vcbMenu.AbsoluteSize.Y

				local topX = vcbTopBar.AbsolutePosition.X
				local topY = vcbTopBar.AbsolutePosition.Y + vcbTopBar.AbsoluteSize.Y + 10

				local x = clamp(topX, 10, math.max(10, vp.X - menuW - 10))
				local y = clamp(topY, 10, math.max(10, vp.Y - menuH - 10))

				vcbMenu.Position = UDim2.new(0, x, 0, y)
			end
		end

		local function toggleMenu()
			setMenuOpen(not vcbOpen)
			updateLayout()
		end

		vcbBtn.MouseButton1Click:Connect(toggleMenu)
		pillBtn.MouseButton1Click:Connect(toggleMenu)
		vcbClose.MouseButton1Click:Connect(function()
			setMenuOpen(false)
		end)

		vcbStart5.MouseButton1Click:Connect(function()
			startTimer(VCB_DEFAULT_5)
		end)

		vcbStart6.MouseButton1Click:Connect(function()
			startTimer(VCB_DEFAULT_6)
		end)

		vcbStop.MouseButton1Click:Connect(function()
			stopTimer()
		end)

		vcbPause.MouseButton1Click:Connect(function()
			pauseTimer()
		end)

		vcbResume.MouseButton1Click:Connect(function()
			resumeTimer()
		end)

		updateLayout()
		if workspace.CurrentCamera then
			workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(updateLayout)
		end

		updateAllText()
	end

	local lastChatTriggerAt = 0

	local function tryChatTriggerVCB(text)
		if type(text) ~= "string" then return end
		local lower = string.lower(text)
		if not string.find(lower, "vcb", 1, true) then return end

		local now = os.clock()
		if (now - lastChatTriggerAt) < 0.25 then return end
		lastChatTriggerAt = now

		startTimer(vcbState.lastDuration or VCB_DEFAULT_5)
	end

	task.spawn(function()
		ensureVcbUi()

		-- If this ever breaks, it's probably Roblox doing that thing where it "helpfully" changes UI sizing.
		LocalPlayer.Chatted:Connect(function(msg)
			tryChatTriggerVCB(msg)
		end)

		if TextChatService and TextChatService.MessageReceived then
			TextChatService.MessageReceived:Connect(function(message)
				if not message then return end
				local src = message.TextSource
				if not src or src.UserId ~= LocalPlayer.UserId then return end
				tryChatTriggerVCB(message.Text or "")
			end)
		end

		RunService.RenderStepped:Connect(function()
			if not vcbState.running then
				return
			end

			if vcbState.paused then
				vcbState.remaining = math.max(0, vcbState.remaining)
				updateTopText()
				return
			end

			vcbState.remaining = math.max(0, vcbState.endAt - os.clock())
			updateTopText()

			if vcbState.remaining <= 0 then
				vcbState.remaining = 0
				updateAllText()

				if vcbState.rejoinArmed and (not vcbState.paused) then
					rejoinSameServer()
				end
			end
		end)
	end)
end

--------------------------------------------------------------------
-- SOS FORCE SHOW TAGS FOR ALL CLIENTS WITH THIS SCRIPT (CHAT SYNC)
-- Paste at the very end of the script
--
-- Chat commands (type exactly):
-- SOS_FORCE_TAG_ADD:<UserId>
-- SOS_FORCE_TAG_ADD:<UserId>:<Role>
-- SOS_FORCE_TAG_REMOVE:<UserId>
-- SOS_FORCE_TAG_CLEAR
--
-- Roles you can use: Normal, Custom, OG, Tester, Sin, Owner, CoOwner
-- Recommendation: use "Custom" or "Normal"
--------------------------------------------------------------------
do
	local Players = game:GetService("Players")
	local LocalPlayer = Players.LocalPlayer
	if not LocalPlayer then return end

	local FORCE_ADD_PREFIX = "SOS_FORCE_TAG_ADD:"
	local FORCE_REMOVE_PREFIX = "SOS_FORCE_TAG_REMOVE:"
	local FORCE_CLEAR = "SOS_FORCE_TAG_CLEAR"

	-- Shared table for this client
	local ForceShowTagUserIds = {}

	-- Default role if not provided
	local DEFAULT_FORCE_ROLE = "Custom"

	-- Store per-user forced role if you want different styles
	local ForceRoleByUserId = {}

	local function clampRole(role)
		if type(role) ~= "string" or role == "" then
			return DEFAULT_FORCE_ROLE
		end
		role = tostring(role)
		-- Only allow known roles to avoid weirdness
		local allowed = {
			Normal = true,
			Custom = true,
			OG = true,
			Tester = true,
			Sin = true,
			Owner = true,
			CoOwner = true,
		}
		if allowed[role] then
			return role
		end
		return DEFAULT_FORCE_ROLE
	end

	local function refreshEveryone()
		task.defer(function()
			for _, p in ipairs(Players:GetPlayers()) do
				if p and p.Character and _G.__SOS_REFRESH_TAGS_FOR_PLAYER then
					_G.__SOS_REFRESH_TAGS_FOR_PLAYER(p)
				end
			end
		end)
	end

	-- Wrap getSosRole so forced users get a role even if they never activated
	local _OLD_getSosRole = getSosRole
	getSosRole = function(plr)
		if plr and ForceShowTagUserIds[plr.UserId] then
			return ForceRoleByUserId[plr.UserId] or DEFAULT_FORCE_ROLE
		end
		return _OLD_getSosRole(plr)
	end

	-- Who is allowed to broadcast force-tag commands
	local function canSendForce(plr)
		if not plr then return false end
		if isOwner(plr) then return true end
		if isCoOwner(plr) then return true end
		-- If you want Sins to also be allowed, keep this line:
		if getSosRole(plr) == "Sin" then return true end
		return false
	end

	local function parseColonParts(s)
		local out = {}
		for token in string.gmatch(s, "([^:]+)") do
			out[#out + 1] = token
		end
		return out
	end

	local function applyForceAdd(userId, role)
		userId = tonumber(userId)
		if not userId then return end
		ForceShowTagUserIds[userId] = true
		ForceRoleByUserId[userId] = clampRole(role)
		refreshEveryone()
	end

	local function applyForceRemove(userId)
		userId = tonumber(userId)
		if not userId then return end
		ForceShowTagUserIds[userId] = nil
		ForceRoleByUserId[userId] = nil
		refreshEveryone()
	end

	local function applyForceClear()
		ForceShowTagUserIds = {}
		ForceRoleByUserId = {}
		refreshEveryone()
	end

	-- Intercept chat commands by wrapping applyCommandFrom (no changes to your original logic)
	local _OLD_applyCommandFrom2 = applyCommandFrom
	applyCommandFrom = function(uid, text)
		-- Let original command handler run first
		if _OLD_applyCommandFrom2 and _OLD_applyCommandFrom2(uid, text) then
			return true
		end

		if typeof(uid) ~= "number" then return false end
		if type(text) ~= "string" then return false end

		local sender = Players:GetPlayerByUserId(uid)
		if not canSendForce(sender) then
			return false
		end

		-- Clear
		if text == FORCE_CLEAR then
			applyForceClear()
			return true
		end

		-- Add
		if text:sub(1, #FORCE_ADD_PREFIX) == FORCE_ADD_PREFIX then
			local payload = text:sub(#FORCE_ADD_PREFIX + 1)
			local parts = parseColonParts(payload)
			-- parts[1] = userid, parts[2] = optional role
			applyForceAdd(parts[1], parts[2])
			return true
		end

		-- Remove
		if text:sub(1, #FORCE_REMOVE_PREFIX) == FORCE_REMOVE_PREFIX then
			local payload = text:sub(#FORCE_REMOVE_PREFIX + 1)
			applyForceRemove(payload)
			return true
		end

		return false
	end

	-- Optional: put any always-forced ids here (everyone with script will see them forced on their own client)
	-- Example:
	-- ForceShowTagUserIds[123456789] = true
	-- ForceRoleByUserId[123456789] = "Custom"
	-- refreshEveryone()
ForceShowTagUserIds[7887807265] = true
ForceShowTagUserIds[375779444] = true
ForceShowTagUserIds[1575141882] = true
ForceShowTagUserIds[4495710706] = true
end

--------------------------------------------------------------------
-- SOS OWNER COOWNER SIN PULL PUSH FREEZE PATCH V5 (PERMISSIONS UPDATE)
-- Replace your V4 admin patch with this block
--------------------------------------------------------------------
do
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")
	local LocalPlayer = Players.LocalPlayer
	if not LocalPlayer then return end

	local PP_LOCK_ATTR = "SOS_PP_AdminPanel_Initialized"
	if LocalPlayer:GetAttribute(PP_LOCK_ATTR) then
		return
	end
	LocalPlayer:SetAttribute(PP_LOCK_ATTR, true)

	local MARK_ACTIVATE = "ð–º—"
	local MARK_REPLY = "Â¬"

	local REPLY_PUSH = "ahh"
	local REPLY_PULL = "ahhh"
	local REPLY_FROZEN = "im frozen"
	local REPLY_STOP = "thank you"

	local ExplicitMarked = {} -- [userId] = true
	local function markExplicit(userId)
		if typeof(userId) ~= "number" then return end
		ExplicitMarked[userId] = true
	end
	local function isExplicitMarked(userId)
		return ExplicitMarked[userId] == true
	end

	local function isTesterRole(plr)
		if not plr then return false end
		return getSosRole(plr) == "Tester"
	end

	local function isSinRole(plr)
		if not plr then return false end
		if getSosRole(plr) == "Sin" then return true end
		if type(SinProfiles) == "table" and SinProfiles[plr.UserId] ~= nil then return true end
		return false
	end

	local function isOwnerRole(plr)
		return plr and (type(isOwner) == "function") and isOwner(plr)
	end

	local function isCoOwnerRole(plr)
		return plr and (type(isCoOwner) == "function") and isCoOwner(plr)
	end

	local function senderRole(plr)
		if isOwnerRole(plr) then return "Owner" end
		if isCoOwnerRole(plr) then return "CoOwner" end
		if isSinRole(plr) then return "Sin" end
		return "None"
	end

	local function isAdminSender(plr)
		local r = senderRole(plr)
		return (r == "Owner") or (r == "CoOwner") or (r == "Sin")
	end

	local function hasSosBillboard(plr)
		if not plr or not plr.Character then return false end
		return plr.Character:FindFirstChild("SOS_RoleTag") ~= nil
	end

	-- Permission rule update:
	-- Owner/CoOwner can affect everyone (including sins).
	-- Sins can affect everyone EXCEPT owners, coowners, and other sins.
	local function canSenderAffectTarget(senderPlr, targetPlr)
		if not senderPlr or not targetPlr then return false end
		if senderPlr.UserId == targetPlr.UserId then return false end

		local sr = senderRole(senderPlr)
		if sr == "Owner" or sr == "CoOwner" then
			return true
		end

		if sr == "Sin" then
			if isOwnerRole(targetPlr) then return false end
			if isCoOwnerRole(targetPlr) then return false end
			if isSinRole(targetPlr) then return false end
			return true
		end

		return false
	end

	-- Eligibility rule used by "all" broadcasts and UI lists
	local function isEligibleTargetFrom(senderPlr, targetPlr)
		if not senderPlr or not targetPlr then return false end
		if not canSenderAffectTarget(senderPlr, targetPlr) then return false end
		if not hasSosBillboard(targetPlr) then return false end
		if not isExplicitMarked(targetPlr.UserId) then return false end
		return true
	end

	local function clampInt(n, a, b, fallback)
		n = tonumber(n)
		if not n then return fallback end
		n = math.floor(n + 0.5)
		if n < a then n = a end
		if n > b then n = b end
		return n
	end

	local function trim(s)
		return (tostring(s or ""):gsub("^%s+", ""):gsub("%s+$", ""))
	end

	local function lower(s)
		return string.lower(tostring(s or ""))
	end

	local function findPlayerByNameLoose(name)
		name = trim(name)
		if name == "" then return nil end
		local n = lower(name)

		for _, p in ipairs(Players:GetPlayers()) do
			if lower(p.Name) == n then return p end
		end
		for _, p in ipairs(Players:GetPlayers()) do
			if lower(p.DisplayName) == n then return p end
		end
		for _, p in ipairs(Players:GetPlayers()) do
			if string.find(lower(p.Name), n, 1, true) then return p end
		end
		return nil
	end

	----------------------------------------------------------------
	-- Anti double fire
	----------------------------------------------------------------
	local RecentMsg = {} -- [key] = time
	local function seenRecently(uid, text, window)
		window = window or 0.35
		local k = tostring(uid) .. "\n" .. tostring(text)
		local now = os.clock()
		local t = RecentMsg[k]
		RecentMsg[k] = now
		if t and (now - t) < window then
			return true
		end
		return false
	end

	----------------------------------------------------------------
	-- Orbit pull system (no elastic fling)
	----------------------------------------------------------------
	local orbitState = {
		active = false,
		adminUserId = 0,
		pullSpeed = 20,
		orbitRadius = 6,
		angle = 0,
		conn = nil,

		ap = nil,
		ao = nil,
		att0 = nil,
		attTarget = nil,
		targetPart = nil,
	}

	local freezeState = {
		frozen = false,
		oldWalkSpeed = nil,
		oldJumpPower = nil,
		oldJumpHeight = nil,
		oldAutoRotate = nil,
	}

	local function clearOrbitObjects()
		if orbitState.conn then pcall(function() orbitState.conn:Disconnect() end) end
		orbitState.conn = nil

		if orbitState.ap and orbitState.ap.Parent then pcall(function() orbitState.ap:Destroy() end) end
		orbitState.ap = nil

		if orbitState.ao and orbitState.ao.Parent then pcall(function() orbitState.ao:Destroy() end) end
		orbitState.ao = nil

		if orbitState.att0 and orbitState.att0.Parent then pcall(function() orbitState.att0:Destroy() end) end
		orbitState.att0 = nil

		if orbitState.attTarget and orbitState.attTarget.Parent then pcall(function() orbitState.attTarget:Destroy() end) end
		orbitState.attTarget = nil

		if orbitState.targetPart and orbitState.targetPart.Parent then pcall(function() orbitState.targetPart:Destroy() end) end
		orbitState.targetPart = nil
	end

	local function stopAllLocal()
		orbitState.active = false
		orbitState.adminUserId = 0
		clearOrbitObjects()
	end

	local function doFreezeOnLocal()
		if freezeState.frozen then return end
		local char = LocalPlayer.Character
		if not char then return end
		local hum = char:FindFirstChildOfClass("Humanoid")
		if not hum then return end

		freezeState.frozen = true
		freezeState.oldWalkSpeed = hum.WalkSpeed
		freezeState.oldJumpPower = hum.JumpPower
		freezeState.oldJumpHeight = hum.JumpHeight
		freezeState.oldAutoRotate = hum.AutoRotate

		hum.WalkSpeed = 0
		hum.JumpPower = 0
		hum.JumpHeight = 0
		hum.AutoRotate = false
	end

	local function doFreezeOffLocal()
		if not freezeState.frozen then return end
		local char = LocalPlayer.Character
		if not char then
			freezeState.frozen = false
			return
		end
		local hum = char:FindFirstChildOfClass("Humanoid")
		if not hum then
			freezeState.frozen = false
			return
		end

		hum.WalkSpeed = freezeState.oldWalkSpeed or 16
		hum.JumpPower = freezeState.oldJumpPower or 50
		hum.JumpHeight = freezeState.oldJumpHeight or 7.2
		if freezeState.oldAutoRotate ~= nil then
			hum.AutoRotate = freezeState.oldAutoRotate
		else
			hum.AutoRotate = true
		end

		freezeState.frozen = false
	end

	local function ensureOrbitConstraints(myHRP)
		if not myHRP then return false end

		if not orbitState.att0 or not orbitState.att0.Parent then
			local a = Instance.new("Attachment")
			a.Name = "SOS_Orbit_Att0"
			a.Parent = myHRP
			orbitState.att0 = a
		end

		if not orbitState.targetPart or not orbitState.targetPart.Parent then
			local p = Instance.new("Part")
			p.Name = "SOS_Orbit_Target"
			p.Anchored = true
			p.CanCollide = false
			p.CanQuery = false
			p.CanTouch = false
			p.Transparency = 1
			p.Size = Vector3.new(1, 1, 1)
			p.Parent = workspace
			orbitState.targetPart = p
		end

		if not orbitState.attTarget or not orbitState.attTarget.Parent then
			local a = Instance.new("Attachment")
			a.Name = "SOS_Orbit_AttTarget"
			a.Parent = orbitState.targetPart
			orbitState.attTarget = a
		end

		if not orbitState.ap or not orbitState.ap.Parent then
			local ap = Instance.new("AlignPosition")
			ap.Name = "SOS_Orbit_AlignPosition"
			ap.Attachment0 = orbitState.att0
			ap.Attachment1 = orbitState.attTarget
			ap.RigidityEnabled = false
			ap.ReactionForceEnabled = false
			ap.ApplyAtCenterOfMass = true
			ap.MaxForce = 65000
			ap.MaxVelocity = 36
			ap.Responsiveness = 18
			ap.Parent = myHRP
			orbitState.ap = ap
		end

		if not orbitState.ao or not orbitState.ao.Parent then
			local ao = Instance.new("AlignOrientation")
			ao.Name = "SOS_Orbit_AlignOrientation"
			ao.Attachment0 = orbitState.att0
			ao.RigidityEnabled = false
			ao.ReactionTorqueEnabled = false
			ao.MaxTorque = 50000
			ao.MaxAngularVelocity = 16
			ao.Responsiveness = 16
			ao.Parent = myHRP
			orbitState.ao = ao
		end

		return true
	end

	local function startOrbitPull(adminUserId, pullSpeed)
		local sender = Players:GetPlayerByUserId(adminUserId)
		if not sender then return end

		if not isEligibleTargetFrom(sender, LocalPlayer) then return end

		orbitState.active = true
		orbitState.adminUserId = adminUserId
		orbitState.pullSpeed = clampInt(pullSpeed, 1, 50, 20)
		orbitState.orbitRadius = 6
		orbitState.angle = 0

		if orbitState.conn then pcall(function() orbitState.conn:Disconnect() end) end

		orbitState.conn = RunService.RenderStepped:Connect(function(dt)
			if not orbitState.active then return end

			local myChar = LocalPlayer.Character
			if not myChar then return end
			local myHRP = myChar:FindFirstChild("HumanoidRootPart")
			if not myHRP then return end

			local admin = Players:GetPlayerByUserId(orbitState.adminUserId)
			local adminChar = admin and admin.Character or nil
			local adminHRP = adminChar and adminChar:FindFirstChild("HumanoidRootPart") or nil

			if not adminHRP then
				if orbitState.targetPart then
					orbitState.targetPart.Position = myHRP.Position
				end
				return
			end

			if not ensureOrbitConstraints(myHRP) then
				stopAllLocal()
				return
			end

			local orbitSpeed = 0.7 + (orbitState.pullSpeed / 50) * 1.8
			orbitState.angle = (orbitState.angle + dt * orbitSpeed) % (math.pi * 2)

			local radius = orbitState.orbitRadius
			local offset = Vector3.new(math.cos(orbitState.angle) * radius, 0, math.sin(orbitState.angle) * radius)

			local basePos = adminHRP.Position
			local desired = Vector3.new(basePos.X, myHRP.Position.Y, basePos.Z) + offset

			if orbitState.targetPart then
				orbitState.targetPart.Position = desired
			end

			if orbitState.ao then
				local look = CFrame.lookAt(myHRP.Position, basePos)
				orbitState.ao.CFrame = look - look.Position
			end

			local v = myHRP.AssemblyLinearVelocity
			local mag = v.Magnitude
			if mag > 45 then
				myHRP.AssemblyLinearVelocity = v.Unit * 45
			end
		end)
	end

	local function doPushBurstFrom(adminUserId, pushPower)
		local sender = Players:GetPlayerByUserId(adminUserId)
		if not sender then return end

		if not isEligibleTargetFrom(sender, LocalPlayer) then return end

		stopAllLocal()

		local myChar = LocalPlayer.Character
		if not myChar then return end
		local myHRP = myChar:FindFirstChild("HumanoidRootPart")
		if not myHRP then return end

		local admin = Players:GetPlayerByUserId(adminUserId)
		local adminChar = admin and admin.Character or nil
		local adminHRP = adminChar and adminChar:FindFirstChild("HumanoidRootPart") or nil
		if not adminHRP then return end

		local p = clampInt(pushPower, 1, 100, 60)

		local delta = (myHRP.Position - adminHRP.Position)
		if delta.Magnitude < 0.1 then
			delta = Vector3.new(0, 0, 1)
		end
		local dir = delta.Unit

		local mass = myHRP.AssemblyMass
		if mass <= 0 then mass = 1 end

		local impulseMag = p * 34 * mass
		pcall(function()
			myHRP:ApplyImpulse(dir * impulseMag)
		end)

		task.delay(0.10, function()
			if myHRP and myHRP.Parent then
				local v = myHRP.AssemblyLinearVelocity
				local mag = v.Magnitude
				if mag > 50 then
					myHRP.AssemblyLinearVelocity = v.Unit * 50
				end
			end
		end)
	end

	LocalPlayer.CharacterAdded:Connect(function()
		task.delay(0.25, function()
			if freezeState.frozen then
				doFreezeOnLocal()
			end
			if orbitState.active and orbitState.adminUserId ~= 0 then
				startOrbitPull(orbitState.adminUserId, orbitState.pullSpeed)
			else
				stopAllLocal()
			end
		end)
	end)

	----------------------------------------------------------------
	-- Parse admin phrases
	----------------------------------------------------------------
	local function parseAdminPhrase(text)
		text = trim(text)
		local t = lower(text)

		if t == "stop" then
			return { kind = "stop", targetMode = "all" }
		end

		if t:sub(1, 6) == "freeze" then
			local rest = trim(text:sub(7))
			if lower(rest) == "all" then
				return { kind = "freezeon", targetMode = "all" }
			end
			local plr = findPlayerByNameLoose(rest)
			if plr then
				return { kind = "freezeon", targetMode = "userid", targetUserId = plr.UserId }
			end
			return nil
		end

		if t:sub(1, 8) == "unfreeze" then
			local rest = trim(text:sub(9))
			if lower(rest) == "all" then
				return { kind = "freezeoff", targetMode = "all" }
			end
			local plr = findPlayerByNameLoose(rest)
			if plr then
				return { kind = "freezeoff", targetMode = "userid", targetUserId = plr.UserId }
			end
			return nil
		end

		if t:sub(1, 9) == "imma pull" then
			local rest = trim(text:sub(10))
			local targetPart, numPart = rest:match("^(.-)%s+(%d+)$")
			if not targetPart then targetPart = rest end

			if lower(targetPart) == "all" then
				return { kind = "pull", targetMode = "all", pullSpeed = tonumber(numPart) }
			end

			local plr = findPlayerByNameLoose(targetPart)
			if plr then
				return { kind = "pull", targetMode = "userid", targetUserId = plr.UserId, pullSpeed = tonumber(numPart) }
			end
			return nil
		end

		if t:sub(1, 9) == "imma push" then
			local rest = trim(text:sub(10))
			local targetPart, numPart = rest:match("^(.-)%s+(%d+)$")
			if not targetPart then targetPart = rest end

			if lower(targetPart) == "all" then
				return { kind = "push", targetMode = "all", pushPower = tonumber(numPart) }
			end

			local plr = findPlayerByNameLoose(targetPart)
			if plr then
				return { kind = "push", targetMode = "userid", targetUserId = plr.UserId, pushPower = tonumber(numPart) }
			end
			return nil
		end

		return nil
	end

	----------------------------------------------------------------
	-- Wrap applyCommandFrom without touching your base logic
	----------------------------------------------------------------
	local _OLD_applyCommandFrom = applyCommandFrom
	applyCommandFrom = function(uid, text)
		if _OLD_applyCommandFrom and _OLD_applyCommandFrom(uid, text) then
			return true
		end

		if typeof(uid) ~= "number" then return false end
		if type(text) ~= "string" then return false end

		if seenRecently(uid, text, 0.35) then
			return false
		end

		if text == MARK_ACTIVATE or text == MARK_REPLY then
			markExplicit(uid)
			return false
		end

		local sender = Players:GetPlayerByUserId(uid)
		if not isAdminSender(sender) then
			return false
		end

		local parsed = parseAdminPhrase(text)
		if not parsed then
			return false
		end

		-- STOP always works locally even if you are not eligible
		if parsed.kind == "stop" then
			trySendChat(REPLY_STOP)
			stopAllLocal()
			doFreezeOffLocal()
			return true
		end

		-- Must be eligible target for this sender
		if not isEligibleTargetFrom(sender, LocalPlayer) then
			return true
		end

		-- If targeted user command, only run for that target
		if parsed.targetMode == "userid" and parsed.targetUserId and LocalPlayer.UserId ~= parsed.targetUserId then
			return true
		end

		local pullSpeed = clampInt(parsed.pullSpeed, 1, 50, 20)
		local pushPower = clampInt(parsed.pushPower, 1, 100, 60)

		if parsed.kind == "pull" then
			trySendChat(REPLY_PULL)
			startOrbitPull(uid, pullSpeed)
			return true
		end

		if parsed.kind == "push" then
			trySendChat(REPLY_PUSH)
			doPushBurstFrom(uid, pushPower)
			return true
		end

		if parsed.kind == "freezeon" then
			trySendChat(REPLY_FROZEN)
			doFreezeOnLocal()
			return true
		end

		if parsed.kind == "freezeoff" then
			trySendChat(REPLY_FROZEN)
			doFreezeOffLocal()
			return true
		end

		return true
	end

	----------------------------------------------------------------
	-- Admin panel UI (Owner, CoOwner, Sin)
	----------------------------------------------------------------
	local function makeDraggable(frame, dragHandle)
		local UIS = game:GetService("UserInputService")
		local dragging = false
		local dragStart = nil
		local startPos = nil
		local handle = dragHandle or frame

		handle.InputBegan:Connect(function(input)
			if input.UserInputType ~= Enum.UserInputType.MouseButton1 and input.UserInputType ~= Enum.UserInputType.Touch then
				return
			end
			dragging = true
			dragStart = input.Position
			startPos = frame.Position

			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end)

		UIS.InputChanged:Connect(function(input)
			if not dragging then return end
			if input.UserInputType ~= Enum.UserInputType.MouseMovement and input.UserInputType ~= Enum.UserInputType.Touch then
				return
			end
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end)
	end

	local function styleCard(frame)
		frame.BackgroundColor3 = Color3.fromRGB(10, 10, 12)
		frame.BackgroundTransparency = 0.22
		frame.BorderSizePixel = 0
		frame.ClipsDescendants = true
		makeCorner(frame, 14)
		makeStroke(frame, 1, Color3.fromRGB(200, 40, 40), 0.22)
	end

	local function makeSmallTitle(parent, txt)
		local l = Instance.new("TextLabel")
		l.BackgroundTransparency = 1
		l.Size = UDim2.new(1, 0, 0, 16)
		l.Font = Enum.Font.GothamBold
		l.TextSize = 12
		l.TextXAlignment = Enum.TextXAlignment.Left
		l.TextColor3 = Color3.fromRGB(215, 215, 215)
		l.Text = txt
		l.Parent = parent
		return l
	end

	local function makeValueRow(parent, labelText, defaultText, minN, maxN)
		local row = Instance.new("Frame")
		row.BackgroundTransparency = 1
		row.Size = UDim2.new(1, 0, 0, 30)
		row.Parent = parent

		local lab = Instance.new("TextLabel")
		lab.BackgroundTransparency = 1
		lab.Position = UDim2.new(0, 0, 0, 6)
		lab.Size = UDim2.new(0.62, -10, 0, 16)
		lab.Font = Enum.Font.GothamBold
		lab.TextSize = 12
		lab.TextXAlignment = Enum.TextXAlignment.Left
		lab.TextColor3 = Color3.fromRGB(200, 200, 200)
		lab.Text = labelText
		lab.Parent = row

		local box = Instance.new("TextBox")
		box.BackgroundColor3 = Color3.fromRGB(16, 16, 20)
		box.BackgroundTransparency = 0.16
		box.BorderSizePixel = 0
		box.Position = UDim2.new(0.62, 0, 0, 2)
		box.Size = UDim2.new(0.38, 0, 0, 26)
		box.Font = Enum.Font.GothamBold
		box.TextSize = 13
		box.TextColor3 = Color3.fromRGB(245, 245, 245)
		box.Text = tostring(defaultText or "")
		box.ClearTextOnFocus = false
		box.Parent = row
		makeCorner(box, 10)
		makeStroke(box, 1, Color3.fromRGB(200, 40, 40), 0.30)

		local function clampBox()
			local v = clampInt(box.Text, minN, maxN, defaultText)
			box.Text = tostring(v)
		end
		box.FocusLost:Connect(clampBox)
		task.defer(clampBox)

		return box
	end

	local function rebuildTargetList(listFrame, selectedUserId, onSelect)
		for _, c in ipairs(listFrame:GetChildren()) do
			if c:IsA("GuiObject") then
				c:Destroy()
			end
		end

		local found = {}
		for _, p in ipairs(Players:GetPlayers()) do
			if isEligibleTargetFrom(LocalPlayer, p) then
				found[#found + 1] = p
			end
		end

		table.sort(found, function(a, b)
			return lower(a.Name) < lower(b.Name)
		end)

		if #found == 0 then
			local empty = Instance.new("TextLabel")
			empty.BackgroundTransparency = 1
			empty.Size = UDim2.new(1, 0, 1, 0)
			empty.Font = Enum.Font.Gotham
			empty.TextSize = 12
			empty.TextColor3 = Color3.fromRGB(170, 170, 170)
			empty.TextXAlignment = Enum.TextXAlignment.Center
			empty.TextYAlignment = Enum.TextYAlignment.Center
			empty.Text = "No eligible targets."
			empty.Parent = listFrame
			return 0
		end

		for _, p in ipairs(found) do
			local b = makeButton(listFrame, p.Name)
			b.Size = UDim2.new(1, 0, 0, 28)

			if p.UserId == selectedUserId then
				b.Text = p.Name .. " (Selected)"
			end

			b.MouseButton1Click:Connect(function()
				onSelect(p.UserId)
			end)
		end

		return #found
	end

	local function buildAdminPanel(panelName)
		ensureGui()

		local panel = Instance.new("Frame")
		panel.Name = panelName
		panel.Size = UDim2.new(0, 360, 0, 410)
		panel.Position = UDim2.new(0, 16, 0, 130)
		panel.BorderSizePixel = 0
		panel.ZIndex = 9300
		panel.Parent = gui
		makeCorner(panel, 16)
		makeGlass(panel)
		makeStroke(panel, 2, Color3.fromRGB(200, 40, 40), 0.10)

		local outerPad = Instance.new("UIPadding")
		outerPad.PaddingTop = UDim.new(0, 10)
		outerPad.PaddingBottom = UDim.new(0, 10)
		outerPad.PaddingLeft = UDim.new(0, 10)
		outerPad.PaddingRight = UDim.new(0, 10)
		outerPad.Parent = panel

		local main = Instance.new("Frame")
		main.BackgroundTransparency = 1
		main.Size = UDim2.new(1, 0, 1, 0)
		main.Parent = panel

		local vlist = Instance.new("UIListLayout")
		vlist.FillDirection = Enum.FillDirection.Vertical
		vlist.SortOrder = Enum.SortOrder.LayoutOrder
		vlist.Padding = UDim.new(0, 8)
		vlist.Parent = main

		local header = Instance.new("Frame")
		header.BackgroundTransparency = 1
		header.Size = UDim2.new(1, 0, 0, 36)
		header.LayoutOrder = 1
		header.Parent = main

		local title = Instance.new("TextButton")
		title.Text = panelName
		title.Font = Enum.Font.GothamBlack
		title.TextSize = 14
		title.TextColor3 = Color3.fromRGB(245, 245, 245)
		title.Size = UDim2.new(1, -92, 1, 0)
		title.Position = UDim2.new(0, 0, 0, 0)
		title.Parent = header
		title.BackgroundColor3 = Color3.fromRGB(16, 16, 20)
		title.BackgroundTransparency = 0.16
		title.BorderSizePixel = 0
		title.AutoButtonColor = false
		makeCorner(title, 12)
		makeStroke(title, 1, Color3.fromRGB(200, 40, 40), 0.22)

		local closeBtn = makeButton(header, "Close")
		closeBtn.Size = UDim2.new(0, 86, 0, 36)
		closeBtn.Position = UDim2.new(1, -86, 0, 0)

		makeDraggable(panel, title)

		local settings = Instance.new("Frame")
		settings.Size = UDim2.new(1, 0, 0, 92)
		settings.LayoutOrder = 2
		settings.Parent = main
		styleCard(settings)

		local sp = Instance.new("UIPadding")
		sp.PaddingTop = UDim.new(0, 10)
		sp.PaddingBottom = UDim.new(0, 10)
		sp.PaddingLeft = UDim.new(0, 10)
		sp.PaddingRight = UDim.new(0, 10)
		sp.Parent = settings

		local sv = Instance.new("UIListLayout")
		sv.FillDirection = Enum.FillDirection.Vertical
		sv.SortOrder = Enum.SortOrder.LayoutOrder
		sv.Padding = UDim.new(0, 6)
		sv.Parent = settings

		makeSmallTitle(settings, "Power Settings")

		local pushBox = makeValueRow(settings, "Push Power (1-100)", 60, 1, 100)
		local pullBox = makeValueRow(settings, "Pull Speed (1-50)", 20, 1, 50)

		local targets = Instance.new("Frame")
		targets.Size = UDim2.new(1, 0, 0, 150)
		targets.LayoutOrder = 3
		targets.Parent = main
		styleCard(targets)

		local tp = Instance.new("UIPadding")
		tp.PaddingTop = UDim.new(0, 10)
		tp.PaddingBottom = UDim.new(0, 10)
		tp.PaddingLeft = UDim.new(0, 10)
		tp.PaddingRight = UDim.new(0, 10)
		tp.Parent = targets

		local titleRow = Instance.new("Frame")
		titleRow.BackgroundTransparency = 1
		titleRow.Size = UDim2.new(1, 0, 0, 16)
		titleRow.Parent = targets

		local leftTitle = Instance.new("TextLabel")
		leftTitle.BackgroundTransparency = 1
		leftTitle.Size = UDim2.new(0.7, 0, 1, 0)
		leftTitle.Font = Enum.Font.GothamBold
		leftTitle.TextSize = 12
		leftTitle.TextXAlignment = Enum.TextXAlignment.Left
		leftTitle.TextColor3 = Color3.fromRGB(215, 215, 215)
		leftTitle.Text = "Eligible Targets"
		leftTitle.Parent = titleRow

		local countLabel = Instance.new("TextLabel")
		countLabel.BackgroundTransparency = 1
		countLabel.Size = UDim2.new(0.3, 0, 1, 0)
		countLabel.Position = UDim2.new(0.7, 0, 0, 0)
		countLabel.Font = Enum.Font.Gotham
		countLabel.TextSize = 12
		countLabel.TextXAlignment = Enum.TextXAlignment.Right
		countLabel.TextColor3 = Color3.fromRGB(170, 170, 170)
		countLabel.Text = "0"
		countLabel.Parent = titleRow

		local hint = Instance.new("TextLabel")
		hint.BackgroundTransparency = 1
		hint.Position = UDim2.new(0, 0, 0, 18)
		hint.Size = UDim2.new(1, 0, 0, 26)
		hint.Font = Enum.Font.Gotham
		hint.TextSize = 11
		hint.TextXAlignment = Enum.TextXAlignment.Left
		hint.TextYAlignment = Enum.TextYAlignment.Top
		hint.TextColor3 = Color3.fromRGB(170, 170, 170)
		hint.TextWrapped = true
		hint.Text = "Needs: typed ð–º— or Â¬ alone, and has SOS tag above head."
		hint.Parent = targets

		local listFrame = Instance.new("ScrollingFrame")
		listFrame.BackgroundColor3 = Color3.fromRGB(12, 12, 14)
		listFrame.BackgroundTransparency = 0.28
		listFrame.BorderSizePixel = 0
		listFrame.Position = UDim2.new(0, 0, 0, 48)
		listFrame.Size = UDim2.new(1, 0, 1, -48)
		listFrame.ScrollBarThickness = 6
		listFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
		listFrame.Parent = targets
		makeCorner(listFrame, 12)
		makeStroke(listFrame, 1, Color3.fromRGB(200, 40, 40), 0.18)

		local lp = Instance.new("UIPadding")
		lp.PaddingTop = UDim.new(0, 8)
		lp.PaddingBottom = UDim.new(0, 8)
		lp.PaddingLeft = UDim.new(0, 8)
		lp.PaddingRight = UDim.new(0, 8)
		lp.Parent = listFrame

		local listLayout = Instance.new("UIListLayout")
		listLayout.FillDirection = Enum.FillDirection.Vertical
		listLayout.SortOrder = Enum.SortOrder.LayoutOrder
		listLayout.Padding = UDim.new(0, 6)
		listLayout.Parent = listFrame

		local commands = Instance.new("Frame")
		commands.Size = UDim2.new(1, 0, 0, 134)
		commands.LayoutOrder = 4
		commands.Parent = main
		styleCard(commands)

		local cp = Instance.new("UIPadding")
		cp.PaddingTop = UDim.new(0, 10)
		cp.PaddingBottom = UDim.new(0, 10)
		cp.PaddingLeft = UDim.new(0, 10)
		cp.PaddingRight = UDim.new(0, 10)
		cp.Parent = commands

		local cmdList = Instance.new("UIListLayout")
		cmdList.FillDirection = Enum.FillDirection.Vertical
		cmdList.SortOrder = Enum.SortOrder.LayoutOrder
		cmdList.Padding = UDim.new(0, 8)
		cmdList.Parent = commands

		makeSmallTitle(commands, "Commands")

		local gridWrap1 = Instance.new("Frame")
		gridWrap1.BackgroundTransparency = 1
		gridWrap1.Size = UDim2.new(1, 0, 0, 62)
		gridWrap1.Parent = commands

		local grid1 = Instance.new("UIGridLayout")
		grid1.CellPadding = UDim2.new(0, 10, 0, 10)
		grid1.CellSize = UDim2.new(0.5, -5, 0, 26)
		grid1.SortOrder = Enum.SortOrder.LayoutOrder
		grid1.Parent = gridWrap1

		local pullAllBtn = makeButton(gridWrap1, "Pull All")
		local pullSelBtn = makeButton(gridWrap1, "Pull Selected")
		local pushAllBtn = makeButton(gridWrap1, "Push All")
		local pushSelBtn = makeButton(gridWrap1, "Push Selected")

		local gridWrap2 = Instance.new("Frame")
		gridWrap2.BackgroundTransparency = 1
		gridWrap2.Size = UDim2.new(1, 0, 0, 62)
		gridWrap2.Parent = commands

		local grid2 = Instance.new("UIGridLayout")
		grid2.CellPadding = UDim2.new(0, 10, 0, 10)
		grid2.CellSize = UDim2.new(0.5, -5, 0, 26)
		grid2.SortOrder = Enum.SortOrder.LayoutOrder
		grid2.Parent = gridWrap2

		local freezeAllBtn = makeButton(gridWrap2, "Freeze All")
		local freezeSelBtn = makeButton(gridWrap2, "Freeze Selected")
		local unfreezeAllBtn = makeButton(gridWrap2, "Unfreeze All")
		local unfreezeSelBtn = makeButton(gridWrap2, "Unfreeze Selected")

		local stopBtn = makeButton(main, "Stop")
		stopBtn.LayoutOrder = 5
		stopBtn.Size = UDim2.new(1, 0, 0, 30)

		local minimized = false
		local selectedUserId = 0

		local function getPushPower()
			return clampInt(pushBox.Text, 1, 100, 60)
		end

		local function getPullSpeed()
			return clampInt(pullBox.Text, 1, 50, 20)
		end

		local function setSelected(uid)
			selectedUserId = uid or 0
		end

		local function getSelectedPlayer()
			if selectedUserId == 0 then return nil end
			return Players:GetPlayerByUserId(selectedUserId)
		end

		local function refreshList()
			local count = rebuildTargetList(listFrame, selectedUserId, function(uid)
				setSelected(uid)
			end)
			countLabel.Text = tostring(count)

			task.defer(function()
				if listLayout and listFrame then
					listFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 16)
				end
			end)
		end

		local function sendPullAll()
			trySendChat("imma pull all " .. tostring(getPullSpeed()))
		end

		local function sendPullSelected()
			local p = getSelectedPlayer()
			if not p then return end
			trySendChat("imma pull " .. p.Name .. " " .. tostring(getPullSpeed()))
		end

		local function sendPushAll()
			trySendChat("imma push all " .. tostring(getPushPower()))
		end

		local function sendPushSelected()
			local p = getSelectedPlayer()
			if not p then return end
			trySendChat("imma push " .. p.Name .. " " .. tostring(getPushPower()))
		end

		local function sendFreezeAll()
			trySendChat("freeze all")
		end

		local function sendFreezeSelected()
			local p = getSelectedPlayer()
			if not p then return end
			trySendChat("freeze " .. p.Name)
		end

		local function sendUnfreezeAll()
			trySendChat("unfreeze all")
		end

		local function sendUnfreezeSelected()
			local p = getSelectedPlayer()
			if not p then return end
			trySendChat("unfreeze " .. p.Name)
		end

		local function sendStop()
			trySendChat("stop")
		end

		pullAllBtn.MouseButton1Click:Connect(sendPullAll)
		pullSelBtn.MouseButton1Click:Connect(sendPullSelected)
		pushAllBtn.MouseButton1Click:Connect(sendPushAll)
		pushSelBtn.MouseButton1Click:Connect(sendPushSelected)

		freezeAllBtn.MouseButton1Click:Connect(sendFreezeAll)
		freezeSelBtn.MouseButton1Click:Connect(sendFreezeSelected)
		unfreezeAllBtn.MouseButton1Click:Connect(sendUnfreezeAll)
		unfreezeSelBtn.MouseButton1Click:Connect(sendUnfreezeSelected)

		stopBtn.MouseButton1Click:Connect(sendStop)

		closeBtn.MouseButton1Click:Connect(function()
			minimized = not minimized
			if minimized then
				panel.Size = UDim2.new(0, 360, 0, 54)
				closeBtn.Text = "Open"
				settings.Visible = false
				targets.Visible = false
				commands.Visible = false
				stopBtn.Visible = false
			else
				panel.Size = UDim2.new(0, 360, 0, 410)
				closeBtn.Text = "Close"
				settings.Visible = true
				targets.Visible = true
				commands.Visible = true
				stopBtn.Visible = true
			end
		end)

		task.spawn(function()
			while panel and panel.Parent do
				refreshList()
				task.wait(1.0)
			end
		end)

		task.defer(refreshList)
		return panel
	end

	task.defer(function()
		if not isAdminSender(LocalPlayer) then
			return
		end

		local r = senderRole(LocalPlayer)
		if r == "Owner" then
			buildAdminPanel("Owner admin panel")
			return
		end
		if r == "CoOwner" then
			buildAdminPanel("Co owner admin panel")
			return
		end
		if r == "Sin" then
			buildAdminPanel("Sin admin panel")
			return
		end
	end)
end

--------------------------------------------------------------------
-- SPECIAL PUSH MENU
-- Only shows for UserId 754232813
-- Only if UserId 4689208231 is in the game
-- Push only targets that person
--------------------------------------------------------------------
do
	local Players = game:GetService("Players")
	local UserInputService = game:GetService("UserInputService")

	local LocalPlayer = Players.LocalPlayer
	if not LocalPlayer then return end

	local CONTROLLER_USERID = 754232813
	local TARGET_USERID = 4689208231

	if LocalPlayer.UserId ~= CONTROLLER_USERID then
		return
	end

	local function getTargetPlayer()
		return Players:GetPlayerByUserId(TARGET_USERID)
	end

	local function canSend()
		return type(trySendChat) == "function"
	end

	local function clampInt(n, a, b, fallback)
		n = tonumber(n)
		if not n then return fallback end
		n = math.floor(n + 0.5)
		if n < a then n = a end
		if n > b then n = b end
		return n
	end

	local function ensureGuiExists()
		if type(ensureGui) == "function" then
			return ensureGui()
		end
		local pg = LocalPlayer:FindFirstChild("PlayerGui")
		if not pg then
			pg = LocalPlayer:WaitForChild("PlayerGui", 5)
		end
		return pg
	end

	local function makeCorner(parent, r)
		local c = Instance.new("UICorner")
		c.CornerRadius = UDim.new(0, r or 12)
		c.Parent = parent
		return c
	end

	local function makeStroke(parent, thickness, color, transparency)
		local s = Instance.new("UIStroke")
		s.Color = color or Color3.fromRGB(0, 0, 0)
		s.Thickness = thickness or 2
		s.Transparency = transparency or 0.25
		s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
		s.Parent = parent
		return s
	end

	local function makeGlass(parent)
		parent.BackgroundColor3 = Color3.fromRGB(10, 10, 12)
		parent.BackgroundTransparency = 0.18

		local grad = Instance.new("UIGradient")
		grad.Rotation = 90
		grad.Color = ColorSequence.new({
			ColorSequenceKeypoint.new(0, Color3.fromRGB(18, 18, 22)),
			ColorSequenceKeypoint.new(0.4, Color3.fromRGB(10, 10, 12)),
			ColorSequenceKeypoint.new(1, Color3.fromRGB(6, 6, 8)),
		})
		grad.Transparency = NumberSequence.new({
			NumberSequenceKeypoint.new(0, 0.05),
			NumberSequenceKeypoint.new(1, 0.20),
		})
		grad.Parent = parent
	end

	local function makeButton(parent, txt)
		local b = Instance.new("TextButton")
		b.BackgroundColor3 = Color3.fromRGB(16, 16, 20)
		b.BackgroundTransparency = 0.2
		b.BorderSizePixel = 0
		b.AutoButtonColor = true
		b.Text = txt or "Button"
		b.Font = Enum.Font.GothamBold
		b.TextSize = 13
		b.TextColor3 = Color3.fromRGB(245, 245, 245)
		b.Parent = parent
		makeCorner(b, 10)

		local st = Instance.new("UIStroke")
		st.Color = Color3.fromRGB(200, 40, 40)
		st.Thickness = 1
		st.Transparency = 0.25
		st.Parent = b

		return b
	end

	local function makeDraggable(frame, handle)
		handle = handle or frame
		local dragging = false
		local dragStart = nil
		local startPos = nil

		handle.InputBegan:Connect(function(input)
			if input.UserInputType ~= Enum.UserInputType.MouseButton1 and input.UserInputType ~= Enum.UserInputType.Touch then
				return
			end
			dragging = true
			dragStart = input.Position
			startPos = frame.Position

			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end)

		UserInputService.InputChanged:Connect(function(input)
			if not dragging then return end
			if input.UserInputType ~= Enum.UserInputType.MouseMovement and input.UserInputType ~= Enum.UserInputType.Touch then
				return
			end
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end)
	end

	local panelGui
	local panel
	local powerBox
	local pushBtn
	local statusLbl

	local function destroyPanel()
		if panel and panel.Parent then
			panel:Destroy()
		end
		panel = nil
		powerBox = nil
		pushBtn = nil
		statusLbl = nil
	end

	local function ensurePanel()
		local target = getTargetPlayer()
		if not target then
			destroyPanel()
			return
		end

		panelGui = ensureGuiExists()
		if not panelGui then return end

		if panel and panel.Parent then
			return
		end

		panel = Instance.new("Frame")
		panel.Name = "SOS_SpecialPushMenu_754232813"
		panel.Size = UDim2.new(0, 320, 0, 150)
		panel.Position = UDim2.new(0, 18, 0, 300)
		panel.BorderSizePixel = 0
		panel.ZIndex = 9400
		panel.Parent = panelGui
		makeCorner(panel, 16)
		makeGlass(panel)
		makeStroke(panel, 2, Color3.fromRGB(200, 40, 40), 0.12)

		local pad = Instance.new("UIPadding")
		pad.PaddingTop = UDim.new(0, 10)
		pad.PaddingBottom = UDim.new(0, 10)
		pad.PaddingLeft = UDim.new(0, 10)
		pad.PaddingRight = UDim.new(0, 10)
		pad.Parent = panel

		local header = Instance.new("TextButton")
		header.Name = "Header"
		header.BackgroundColor3 = Color3.fromRGB(16, 16, 20)
		header.BackgroundTransparency = 0.16
		header.BorderSizePixel = 0
		header.AutoButtonColor = false
		header.Text = "Push panel"
		header.Font = Enum.Font.GothamBlack
		header.TextSize = 14
		header.TextColor3 = Color3.fromRGB(245, 245, 245)
		header.Size = UDim2.new(1, -86, 0, 30)
		header.Position = UDim2.new(0, 0, 0, 0)
		header.ZIndex = 9401
		header.Parent = panel
		makeCorner(header, 12)
		makeStroke(header, 1, Color3.fromRGB(200, 40, 40), 0.25)

		local closeBtn = makeButton(panel, "Close")
		closeBtn.Size = UDim2.new(0, 78, 0, 30)
		closeBtn.Position = UDim2.new(1, -78, 0, 0)
		closeBtn.ZIndex = 9401

		statusLbl = Instance.new("TextLabel")
		statusLbl.BackgroundTransparency = 1
		statusLbl.Position = UDim2.new(0, 0, 0, 38)
		statusLbl.Size = UDim2.new(1, 0, 0, 18)
		statusLbl.Font = Enum.Font.Gotham
		statusLbl.TextSize = 12
		statusLbl.TextXAlignment = Enum.TextXAlignment.Left
		statusLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
		statusLbl.ZIndex = 9401
		statusLbl.Parent = panel

		local powerLbl = Instance.new("TextLabel")
		powerLbl.BackgroundTransparency = 1
		powerLbl.Position = UDim2.new(0, 0, 0, 64)
		powerLbl.Size = UDim2.new(0.58, -10, 0, 18)
		powerLbl.Font = Enum.Font.GothamBold
		powerLbl.TextSize = 12
		powerLbl.TextXAlignment = Enum.TextXAlignment.Left
		powerLbl.TextColor3 = Color3.fromRGB(220, 220, 220)
		powerLbl.Text = "Push Power (1-100)"
		powerLbl.ZIndex = 9401
		powerLbl.Parent = panel

		powerBox = Instance.new("TextBox")
		powerBox.BackgroundColor3 = Color3.fromRGB(16, 16, 20)
		powerBox.BackgroundTransparency = 0.16
		powerBox.BorderSizePixel = 0
		powerBox.Position = UDim2.new(0.58, 0, 0, 58)
		powerBox.Size = UDim2.new(0.42, 0, 0, 28)
		powerBox.Font = Enum.Font.GothamBold
		powerBox.TextSize = 13
		powerBox.TextColor3 = Color3.fromRGB(245, 245, 245)
		powerBox.Text = "60"
		powerBox.ClearTextOnFocus = false
		powerBox.ZIndex = 9401
		powerBox.Parent = panel
		makeCorner(powerBox, 10)
		makeStroke(powerBox, 1, Color3.fromRGB(200, 40, 40), 0.30)

		pushBtn = makeButton(panel, "Push target")
		pushBtn.Size = UDim2.new(1, 0, 0, 34)
		pushBtn.Position = UDim2.new(0, 0, 0, 104)
		pushBtn.ZIndex = 9401

		local function refreshText()
			local t = getTargetPlayer()
			if not t then
				statusLbl.Text = "Target not in server."
				pushBtn.Text = "Push target"
				return
			end
			statusLbl.Text = "Target: " .. t.Name .. " (" .. tostring(TARGET_USERID) .. ")"
			pushBtn.Text = "Push " .. t.Name
		end

		local function clampBox()
			if not powerBox then return end
			local v = clampInt(powerBox.Text, 1, 100, 60)
			powerBox.Text = tostring(v)
		end

		powerBox.FocusLost:Connect(clampBox)

		pushBtn.MouseButton1Click:Connect(function()
			local t = getTargetPlayer()
			if not t then
				refreshText()
				return
			end
			if not canSend() then return end

			clampBox()
			local power = clampInt(powerBox.Text, 1, 100, 60)

			-- Uses your existing parser: imma push <name> <power>
			trySendChat("imma push " .. t.Name .. " " .. tostring(power))
		end)

		closeBtn.MouseButton1Click:Connect(function()
			destroyPanel()
		end)

		makeDraggable(panel, header)
		refreshText()

		task.spawn(function()
			while panel and panel.Parent do
				refreshText()
				task.wait(0.8)
			end
		end)
	end

	-- Show or hide based on whether target is present
	local function reconcile()
		if getTargetPlayer() then
			ensurePanel()
		else
			destroyPanel()
		end
	end

	reconcile()
	Players.PlayerAdded:Connect(function(plr)
		if plr and plr.UserId == TARGET_USERID then
			task.delay(0.1, reconcile)
		end
	end)

	Players.PlayerRemoving:Connect(function(plr)
		if plr and plr.UserId == TARGET_USERID then
			task.delay(0.05, reconcile)
		end
	end)
end
